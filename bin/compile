#!/usr/bin/env bash
# Cloud Foundry Micromamba Buildpack
# [License and copyright details]

set -eo pipefail

echo "-----> Retrieve environment variables"
ENV_DIR=$3
for KEY in ENVIRONMENT_YML ADDITIONAL_ENVIRONMENT_YML; do
  [ -f $ENV_DIR/$KEY ] && export "$KEY=$(cat $ENV_DIR/$KEY)" 
done
[ -z "$ENVIRONMENT_YML" ] || echo "ENVIRONMENT_YML: $ENVIRONMENT_YML"
[ -z "$ADDITIONAL_ENVIRONMENT_YML" ] || echo "ADDITIONAL_ENVIRONMENT_YML: $ADDITIONAL_ENVIRONMENT_YML"

echo "-----> Starting compile step..."
mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)

micromamba_temp="$HOME/.micromamba"
# fix cloudfoundry path issues
if [ "$HOME" == "/home/vcap" ]; then micromamba_temp="$HOME/app/.micromamba"; fi

echo "-----> Preparing Python Environment..."

echo "---> Downloading and installing Micromamba..."
curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba -C $micromamba_temp
export PATH=$PATH:$micromamba_temp/bin

echo "---> Creating and activating the environment"
# check $ENVIRONMENT_YML for alternative environment.yml
if [ -z "$ENVIRONMENT_YML" ]; then 
    environmentYMLPath="$build/environment.yml"
else
    environmentYMLPath="$build/$ENVIRONMENT_YML"
fi
micromamba create -n myenv -f "$environmentYMLPath" -y
micromamba activate myenv

echo "-----> Installing Dependencies using $environmentYMLPath"

echo "-----> Listing Python Environment Information..."
micromamba list

echo "-----> Add additional environment.yml..."
if [ ! -z "$ADDITIONAL_ENVIRONMENT_YML" ]; then
    micromamba create -n additional_env -f $build/$ADDITIONAL_ENVIRONMENT_YML -y
fi

echo "-----> Cleaning Python Environment..."
micromamba clean --all --yes

echo "-----> Copy to staging area"
micromamba_build="$build/.micromamba"
if [ -e $micromamba_build ]; then rm -rf $micromamba_build; fi
mkdir -p $micromamba_build
cp -a $micromamba_temp/* $micromamba_build/

echo "-----> Finished compile step"

echo "-----> Create .profile.d"
mkdir -p $build/.profile.d
cat <<-'EOF' > $build/.profile.d/micromamba.sh
# append to path variable
export PATH=$HOME/.micromamba/bin:$PATH
micromamba activate myenv

# set default encoding to UTF-8
export LC_ALL=C.UTF-8
export LANG=C.UTF-8  
EOF

echo "-----> Purging cache"
rm -rf $cache/*
